{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header pb-0 card-no-border">
          <h5 class="mb-3">Breached Credentials for Companies</h5>
          <p class="f-m-light mt-1">
            Breached credential records discovered for your watchlisted applications, domains, and IPs.
            Use the filters below to focus on what matters.
          </p>
          <div class="card-header-right">
            {% if current_user.can_edit() %}
            <a href="{{ url_for('threat_intel.breached_creds_add') }}" class="btn btn-primary btn-sm">
              <i data-feather="plus" style="width: 14px; height: 14px;"></i> Add New
            </a>
            {% endif %}
            <a href="{{ url_for('threat_intel.analysis') }}" class="btn btn-info btn-sm">
              <i data-feather="bar-chart-2" style="width: 14px; height: 14px;"></i> Analysis
            </a>
            <a href="{{ url_for('threat_intel.reports') }}" class="btn btn-secondary btn-sm">
              <i data-feather="file-text" style="width: 14px; height: 14px;"></i> Reports
            </a>
            <a href="{{ url_for('threat_intel.breached_creds_export', type=filters.type or '', source=filters.source or '', domain=filters.domain or '', search=filters.search or '', date_filter=filters.date_filter or '') }}" class="btn btn-success btn-sm" id="export-btn">
              <i data-feather="download" style="width: 14px; height: 14px;"></i> Export CSV
            </a>
          </div>
        </div>
        <div class="card-body">
          <!-- Quick Date Filters (reverted from screenshot-style dropdown) -->
          <div class="mb-3">
            <div class="btn-group" role="group" aria-label="Date filter">
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='today', type=filters.type or '', source=filters.source or '', domain=filters.domain or '', search=filters.search or '') }}"
                 class="btn btn-sm {% if filters.date_filter == 'today' %}btn-primary{% else %}btn-secondary{% endif %}">
                Today
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='week', type=filters.type or '', source=filters.source or '', domain=filters.domain or '', search=filters.search or '') }}"
                 class="btn btn-sm {% if filters.date_filter == 'week' or not filters.date_filter %}btn-primary{% else %}btn-secondary{% endif %}">
                This Week
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='month', type=filters.type or '', source=filters.source or '', domain=filters.domain or '', search=filters.search or '') }}"
                 class="btn btn-sm {% if filters.date_filter == 'month' %}btn-primary{% else %}btn-secondary{% endif %}">
                This Month
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='all', type=filters.type or '', source=filters.source or '', domain=filters.domain or '', search=filters.search or '') }}"
                 class="btn btn-sm {% if filters.date_filter == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">
                All Time
              </a>
            </div>
          </div>

          <!-- Filters -->
          <form method="GET" class="mb-4" id="filter-form">
            <input type="hidden" name="date_filter" value="{{ filters.date_filter }}">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Type</label>
                <select class="form-select" name="type">
                  <option value="">All Types</option>
                  <option value="combolist" {% if filters.type == 'combolist' %}selected{% endif %}>Combolist</option>
                  <option value="stealer" {% if filters.type == 'stealer' %}selected{% endif %}>Stealer</option>
                  <option value="malware" {% if filters.type == 'malware' %}selected{% endif %}>Malware</option>
                  <option value="pastebin" {% if filters.type == 'pastebin' %}selected{% endif %}>Pastebin</option>
                  <option value="breach" {% if filters.type == 'breach' %}selected{% endif %}>Breach</option>
                  <option value="phishing" {% if filters.type == 'phishing' %}selected{% endif %}>Phishing</option>
                  <option value="darkweb" {% if filters.type == 'darkweb' %}selected{% endif %}>Darkweb</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Source</label>
                <input type="text" class="form-control" name="source" placeholder="Filter by source" value="{{ filters.source or '' }}">
              </div>
              <div class="col-md-3">
                <label class="form-label">Domain</label>
                <input type="text" class="form-control" name="domain" placeholder="Filter by domain" value="{{ filters.domain or '' }}">
              </div>
              <div class="col-md-3 d-flex align-items-end justify-content-end gap-2">
                <button type="submit" class="btn btn-primary btn-sm" id="filter-btn">
                  <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  Filter
                </button>
                <a href="{{ url_for('threat_intel.breached_creds_list') }}" class="btn btn-secondary btn-sm">Clear</a>
              </div>
            </div>

            <!-- Search row (split from filter selects, like screenshot) -->
            <div class="d-flex justify-content-end align-items-center mt-3">
              <div class="d-flex align-items-center gap-2">
                <label class="col-form-label mb-0">Search:</label>
                <input type="text" class="form-control" name="search" placeholder="Search username, domain, password..." value="{{ filters.search }}">
              </div>
            </div>
          </form>

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Username</th>
                  <th>Domain</th>
                  <th>Password</th>
                  <th>Source</th>
                  <th>Type</th>
                  <th>URL</th>
                  <th>Score</th>
                  <th>Created</th>
                  <th>Marked</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if breached_creds %}
                  {% for cred in breached_creds %}
                  <tr>
                    <td>{{ cred.username or '-' }}</td>
                    <td><span class="badge badge-light-info">{{ cred.domain or '-' }}</span></td>
                    <td>
                      {% if cred.password %}
                        <span class="password-mask" data-password="{{ cred.password }}" title="Hover to reveal password">
                          <span class="masked-password">••••••••</span>
                          <span class="revealed-password">{{ cred.password }}</span>
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>{{ cred.source or '-' }}</td>
                    <td>
                      {% if cred.type %}
                        <span class="badge badge-light-{{ cred.type_color }}">{{ cred.type|title }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if cred.url %}
                        <a href="{{ cred.url }}" target="_blank" rel="noopener noreferrer" class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ cred.url }}">
                          {{ cred.url }}
                        </a>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if cred._score is not none %}
                        <span class="badge badge-light-secondary">{{ "%.2f"|format(cred._score) }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>{{ cred.created_at.strftime('%Y-%m-%d') if cred.created_at else '-' }}</td>
                    <td>
                      {% if cred.is_marked %}
                        <span class="badge badge-light-warning" title="Marked by {{ cred.marker.username if cred.marker else 'Unknown' }}">
                          <i data-feather="check-circle" style="width: 12px; height: 12px;"></i> Marked
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      <ul class="action mb-0">
                        <li class="edit">
                          <a href="{{ url_for('threat_intel.breached_creds_view', id=cred.id) }}" title="View">
                            <i class="fa-regular fa-eye"></i>
                          </a>
                        </li>
                        {% if current_user.can_edit() %}
                        <li class="edit">
                          <a href="{{ url_for('threat_intel.breached_creds_edit', id=cred.id) }}" title="Edit">
                            <i class="fa-regular fa-pen-to-square"></i>
                          </a>
                        </li>
                        {% endif %}
                        {% if current_user.can_delete() %}
                        <li class="delete">
                          <form method="POST" action="{{ url_for('threat_intel.breached_creds_delete', id=cred.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" style="border:0;background:transparent;padding:0;" title="Delete">
                              <i class="fa-solid fa-trash-can"></i>
                            </button>
                          </form>
                        </li>
                        {% endif %}
                      </ul>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="10" class="text-center">No breached credentials found.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if pagination.pages > 1 %}
          <div class="table-responsive">
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination pagination-primary justify-content-center">
                {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.domain %}&domain={{ filters.domain }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="First">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link" aria-label="First"><span aria-hidden="true">&laquo;</span></span></li>
                {% endif %}

                {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.prev_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.domain %}&domain={{ filters.domain }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Previous">
                      <span aria-hidden="true">&lsaquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link" aria-label="Previous"><span aria-hidden="true">&lsaquo;</span></span></li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                  {% if page_num %}
                    {% if page_num == pagination.page %}
                      <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                    {% else %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ page_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.domain %}&domain={{ filters.domain }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}">{{ page_num }}</a>
                      </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                  {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.next_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.domain %}&domain={{ filters.domain }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Next">
                      <span aria-hidden="true">&rsaquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link" aria-label="Next"><span aria-hidden="true">&rsaquo;</span></span></li>
                {% endif %}

                {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.pages }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.source %}&source={{ filters.source }}{% endif %}{% if filters.domain %}&domain={{ filters.domain }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Last">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link" aria-label="Last"><span aria-hidden="true">&raquo;</span></span></li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scriptcontent %}
{% endblock %}

