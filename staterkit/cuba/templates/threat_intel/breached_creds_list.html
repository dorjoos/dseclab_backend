{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5>Breached Credentials for Companies</h5>
          <div class="card-header-right">
            {% if current_user.can_edit() %}
            <a href="{{ url_for('threat_intel.breached_creds_add') }}" class="btn btn-primary btn-sm">
              <i data-feather="plus"></i> Add New
            </a>
            {% endif %}
            <a href="{{ url_for('threat_intel.analysis') }}" class="btn btn-info btn-sm">
              <i data-feather="bar-chart-2"></i> Analysis
            </a>
            <a href="{{ url_for('threat_intel.reports') }}" class="btn btn-secondary btn-sm">
              <i data-feather="file-text"></i> Reports
            </a>
            <a href="{{ url_for('threat_intel.breached_creds_export', company=filters.company or '', company_type=filters.company_type or '', severity=filters.severity or '', status=filters.status or '', search=filters.search or '', date_filter=filters.date_filter or '') }}" class="btn btn-success btn-sm" id="export-btn">
              <i data-feather="download"></i> Export CSV
            </a>
            <i class="icofont icofont-maximize full-card"></i>
            <i class="icofont icofont-minus minimize-card"></i>
            <i class="icofont icofont-refresh reload-card"></i>
            <i class="icofont icofont-error close-card"></i>
          </div>
        </div>
        <div class="card-body">
          <!-- Statistics Cards -->
          <div class="row mb-4">
            <div class="col-xl-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-primary rounded p-2">
                        <i data-feather="database" class="text-white"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="f-w-400 mb-1">Total Records</h6>
                      <h4 class="mb-0">{{ stats.total }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-danger rounded p-2">
                        <i data-feather="alert-circle" class="text-white"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="f-w-400 mb-1">Stealer</h6>
                      <h4 class="mb-0">{{ stats.by_type.get('stealer', 0) if stats.by_type else 0 }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-warning rounded p-2">
                        <i data-feather="alert-triangle" class="text-white"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="f-w-400 mb-1">Malware</h6>
                      <h4 class="mb-0">{{ stats.by_type.get('malware', 0) if stats.by_type else 0 }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                      <div class="bg-info rounded p-2">
                        <i data-feather="activity" class="text-white"></i>
                      </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                      <h6 class="f-w-400 mb-1">Active</h6>
                      <h4 class="mb-0">{{ stats.by_status.get('active', 0) if stats.by_status else 0 }}</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Date Filters -->
          <div class="mb-3">
            <div class="btn-group" role="group">
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='today', company=filters.company or '', company_type=filters.company_type or '', type=filters.type or '', leak_category=filters.leak_category or '', status=filters.status or '', search=filters.search or '') }}" 
                 class="btn btn-sm {% if filters.date_filter == 'today' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                Today
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='week', company=filters.company or '', company_type=filters.company_type or '', severity=filters.severity or '', status=filters.status or '', search=filters.search or '') }}" 
                 class="btn btn-sm {% if filters.date_filter == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                This Week
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='month', company=filters.company or '', company_type=filters.company_type or '', severity=filters.severity or '', status=filters.status or '', search=filters.search or '') }}" 
                 class="btn btn-sm {% if filters.date_filter == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                This Month
              </a>
              <a href="{{ url_for('threat_intel.breached_creds_list', date_filter='all', company=filters.company or '', company_type=filters.company_type or '', severity=filters.severity or '', status=filters.status or '', search=filters.search or '') }}" 
                 class="btn btn-sm {% if filters.date_filter == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                All Time
              </a>
            </div>
          </div>

          <!-- Filters -->
          <form method="GET" class="mb-4" id="filter-form">
            <input type="hidden" name="date_filter" value="{{ filters.date_filter }}">
            <div class="row">
              <div class="col-md-3">
                <input type="text" class="form-control" name="search" placeholder="Search email, application..." value="{{ filters.search }}">
              </div>
              <div class="col-md-2">
                <select class="form-control" name="company_type">
                  <option value="">All Company Types</option>
                  <option value="bank" {% if filters.company_type == 'bank' %}selected{% endif %}>Bank</option>
                  <option value="operator" {% if filters.company_type == 'operator' %}selected{% endif %}>Operator</option>
                  <option value="government" {% if filters.company_type == 'government' %}selected{% endif %}>Government</option>
                  <option value="other" {% if filters.company_type == 'other' %}selected{% endif %}>Other</option>
                </select>
              </div>
              <div class="col-md-2">
                <select class="form-control" name="severity">
                  <option value="">All Severities</option>
                  <option value="low" {% if filters.severity == 'low' %}selected{% endif %}>Low</option>
                  <option value="medium" {% if filters.severity == 'medium' %}selected{% endif %}>Medium</option>
                  <option value="high" {% if filters.severity == 'high' %}selected{% endif %}>High</option>
                  <option value="critical" {% if filters.severity == 'critical' %}selected{% endif %}>Critical</option>
                </select>
              </div>
              <div class="col-md-2">
                        <select class="form-control" name="status">
                          <option value="">All Statuses</option>
                          <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Active</option>
                          <option value="new" {% if filters.status == 'new' %}selected{% endif %}>New</option>
                        </select>
              </div>
              <div class="col-md-3">
                <button type="submit" class="btn btn-primary btn-sm" id="filter-btn">
                  <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                  Filter
                </button>
                <a href="{{ url_for('threat_intel.breached_creds_list') }}" class="btn btn-secondary btn-sm">Clear</a>
              </div>
            </div>
          </form>

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Application</th>
                  <th>Company Type</th>
                  <th>Leaked Account</th>
                  <th>Domain</th>
                  <th>Type</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Marked</th>
                  <th>Discovered</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if breached_creds %}
                  {% for cred in breached_creds %}
                  <tr>
                    <td>
                      <strong>{{ cred.application }}</strong>
                    </td>
                    <td><span class="badge badge-light-secondary">{{ cred.company_type }}</span></td>
                    <td>{{ cred.email }}</td>
                    <td><span class="badge badge-light-info">{{ cred.email_domain }}</span></td>
                    <td>
                      <span class="badge badge-light-{{ cred.type_color }}">
                        {{ cred.type|title }}
                      </span>
                    </td>
                    <td>
                      {% if cred.leak_category == 'corporate' %}
                        <span class="badge badge-light-warning">Corporate</span>
                      {% else %}
                        <span class="badge badge-light-info">Consumer</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if cred.status == 'active' %}
                        <span class="badge badge-light-danger">Active</span>
                      {% elif cred.status == 'new' %}
                        <span class="badge badge-light-primary">New</span>
                      {% else %}
                        <span class="badge badge-light-secondary">{{ cred.status|title }}</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if cred.is_marked %}
                        <span class="badge badge-light-warning" title="Marked by {{ cred.marker.username if cred.marker else 'Unknown' }}">
                          <i data-feather="check-circle" style="width: 12px; height: 12px;"></i> Marked
                        </span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>{{ cred.discovered_date.strftime('%Y-%m-%d') if cred.discovered_date else '-' }}</td>
                    <td>
                      <div class="action-items">
                        <a href="{{ url_for('threat_intel.breached_creds_view', id=cred.id) }}" class="btn btn-outline-primary btn-xs" title="View" data-bs-toggle="tooltip">
                          <i data-feather="eye"></i>
                        </a>
                        {% if current_user.can_mark() %}
                        <form method="POST" action="{{ url_for('threat_intel.breached_creds_mark', id=cred.id) }}" style="display: inline;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                          <button type="submit" class="btn btn-xs {% if cred.is_marked %}btn-warning{% else %}btn-outline-warning{% endif %}" title="{% if cred.is_marked %}Unmark{% else %}Mark{% endif %}" data-bs-toggle="tooltip">
                            <i data-feather="{% if cred.is_marked %}check-circle{% else %}circle{% endif %}"></i>
                          </button>
                        </form>
                        {% endif %}
                        {% if current_user.can_edit() %}
                        <a href="{{ url_for('threat_intel.breached_creds_edit', id=cred.id) }}" class="btn btn-outline-primary btn-xs" title="Edit" data-bs-toggle="tooltip">
                          <i data-feather="edit"></i>
                        </a>
                        {% endif %}
                        {% if current_user.can_delete() %}
                        <form method="POST" action="{{ url_for('threat_intel.breached_creds_delete', id=cred.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                          <button type="submit" class="btn btn-outline-danger btn-xs" title="Delete" data-bs-toggle="tooltip">
                            <i data-feather="trash-2"></i>
                          </button>
                        </form>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="11" class="text-center">No breached credentials found.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if pagination.pages > 1 %}
          <div class="table-responsive">
            <nav aria-label="Page navigation" class="mt-3">
              <ul class="pagination pagination-primary justify-content-center">
                <!-- First Page Button -->
                {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.company %}&company={{ filters.company }}{% endif %}{% if filters.company_type %}&company_type={{ filters.company_type }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.leak_category %}&leak_category={{ filters.leak_category }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="First">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="First">
                      <span aria-hidden="true">&laquo;</span>
                    </span>
                  </li>
                {% endif %}
                
                <!-- Previous Page Button -->
                {% if pagination.has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.prev_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.company %}&company={{ filters.company }}{% endif %}{% if filters.company_type %}&company_type={{ filters.company_type }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.leak_category %}&leak_category={{ filters.leak_category }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Previous">
                      <span aria-hidden="true">&lsaquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="Previous">
                      <span aria-hidden="true">&lsaquo;</span>
                    </span>
                  </li>
                {% endif %}
                
                <!-- Page Numbers -->
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                  {% if page_num %}
                    {% if page_num == pagination.page %}
                      <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                      </li>
                    {% else %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ page_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.company %}&company={{ filters.company }}{% endif %}{% if filters.company_type %}&company_type={{ filters.company_type }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.leak_category %}&leak_category={{ filters.leak_category }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}">
                          {{ page_num }}
                        </a>
                      </li>
                    {% endif %}
                  {% else %}
                    <li class="page-item disabled">
                      <span class="page-link">...</span>
                    </li>
                  {% endif %}
                {% endfor %}
                
                <!-- Next Page Button -->
                {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.next_num }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.company %}&company={{ filters.company }}{% endif %}{% if filters.company_type %}&company_type={{ filters.company_type }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.leak_category %}&leak_category={{ filters.leak_category }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Next">
                      <span aria-hidden="true">&rsaquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="Next">
                      <span aria-hidden="true">&rsaquo;</span>
                    </span>
                  </li>
                {% endif %}
                
                <!-- Last Page Button -->
                {% if pagination.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ pagination.pages }}{% if filters.search %}&search={{ filters.search }}{% endif %}{% if filters.company %}&company={{ filters.company }}{% endif %}{% if filters.company_type %}&company_type={{ filters.company_type }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.leak_category %}&leak_category={{ filters.leak_category }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.date_filter %}&date_filter={{ filters.date_filter }}{% endif %}" aria-label="Last">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="Last">
                      <span aria-hidden="true">&raquo;</span>
                    </span>
                  </li>
                {% endif %}
              </ul>
            </nav>
            <div class="text-center mt-2">
              <small class="text-muted">
                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to 
                {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
                of {{ pagination.total }} entries
              </small>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
