{% extends "base.html" %}

{% block content %}
<!-- Container-fluid starts-->
<div class="container-fluid list-product-view product-wrapper">
  <div class="row"> 
    <div class="col-12">
      <div class="card">
        <div class="card-header card-no-border text-end">
          <div class="card-header-right-icon">
            <a class="btn btn-primary f-w-500" href="{{ url_for('admin.add_company') }}">
              <i class="fa fa-plus pe-2"></i>Add Company
            </a>
          </div>
        </div>
        <div class="card-body px-0 pt-0">
          <div class="list-product">
            <div class="recent-table table-responsive custom-scrollbar product-list-table">
              <table class="table" id="product-list-view">
                <thead>
                  <tr>
                    <th></th>
                    <th> <span class="c-o-light f-w-600">Company</span></th>
                    <th> <span class="c-o-light f-w-600">Domain</span></th>
                    <th> <span class="c-o-light f-w-600">Type</span></th>
                    <th> <span class="c-o-light f-w-600">Watchlist</span></th>
                    <th> <span class="c-o-light f-w-600">Users</span></th>
                    <th> <span class="c-o-light f-w-600">Breached Creds</span></th>
                    <th> <span class="c-o-light f-w-600">Created</span></th>
                    <th> <span class="c-o-light f-w-600">Action</span></th>
                  </tr>
                </thead>
                <tbody>
                  {% if companies %}
                    {% for company in companies %}
                    <tr class="product-removes">
                      <td></td>
                      <td> 
                        <div class="product-names">
                          <div class="light-product-box">
                            <!-- keep product image style; use a generic company icon -->
                            <img class="img-fluid"
                                 src="{{ url_for('static', filename = 'assets/images/dashboard-8/product-categories/laptop.png') }}"
                                 alt="{{ company.name or 'Company' }}">
                          </div>
                          <p>{{ company.name }}</p>
                        </div>
                      </td>
                      <td>
                        <!-- SKU column → show domain -->
                        <p class="c-o-light">{{ company.domain or '-' }}</p>
                      </td>
                      <td>
                        <!-- Category column → company type -->
                        <p class="c-o-light">{{ company.company_type or 'other' }}</p>
                      </td>
                      <td>
                        <!-- Price column → watchlist count -->
                        <p class="c-o-light">
                          {{ company.watchlist_entries|length }} watchlist
                        </p>
                      </td>
                      <td>
                        <!-- Qty column → user count -->
                        <p class="c-o-light">
                          {{ company.users|length }} users
                        </p>
                      </td>
                      <td>
                        <!-- Status column → breached creds count badge -->
                        <a href="{{ url_for('admin.company_breached_creds', company_id=company.id) }}" 
                           class="badge badge-light-danger">
                          {{ company_stats.get(company.id, 0) }} breaches
                        </a>
                      </td>
                      <td>
                        <!-- Rating column → created date -->
                        <p class="c-o-light">
                          {{ company.created_at.strftime('%Y-%m-%d') if company.created_at else '-' }}
                        </p>
                      </td>
                      <td>
                        <div class="product-action">
                          <a class="square-white"
                             href="{{ url_for('admin.edit_company', company_id=company.id) }}"
                             title="Edit Company">
                            <svg>
                              <use href="{{ url_for('static', filename = 'assets/svg/icon-sprite.svg' )}}#edit-content"></use>
                            </svg>
                          </a>
                          {% if current_user.can_delete() %}
                          <form method="POST"
                                action="{{ url_for('admin.delete_company', company_id=company.id) }}"
                                class="company-delete-form"
                                data-company-name="{{ company.name }}"
                                style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="square-white company-delete-btn" title="Delete Company" style="border:0;background:transparent;padding:0;">
                              <svg>
                                <use href="{{ url_for('static', filename = 'assets/svg/icon-sprite.svg' )}}#trash1"></use>
                              </svg>
                            </button>
                          </form>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="9" class="text-center">No companies found.</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
></div>
<!-- Container-fluid Ends-->
{% endblock %}

{% block scriptcontent %}
<script src="{{ url_for('static', filename = 'assets/js/sweet-alert/sweetalert.min.js')}}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Require either SweetAlert2 (Swal) or SweetAlert (swal)
    if (typeof Swal === 'undefined' && typeof swal === 'undefined') {
      return;
    }
    document.querySelectorAll('.company-delete-form').forEach(function (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var companyName = form.getAttribute('data-company-name') || 'this company';

        if (typeof Swal !== 'undefined') {
          // SweetAlert2 style
          Swal.fire({
            title: 'Are you sure?',
            html: 'Do you really want to delete <strong>' + companyName + '</strong>?',
            imageUrl: "{{ url_for('static', filename = 'assets/images/gif/trash.gif') }}",
            imageWidth: 120,
            imageHeight: 120,
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            reverseButtons: true
          }).then(function (result) {
            if (result.isConfirmed) {
              form.submit();
            }
          });
        } else if (typeof swal !== 'undefined') {
          // SweetAlert v1 style
          swal({
            title: 'Are you sure?',
            text: 'Do you really want to delete ' + companyName + '?',
            icon: 'warning',
            buttons: ['Cancel', 'Yes, delete it!'],
            dangerMode: true
          }).then(function (willDelete) {
            if (willDelete) {
              form.submit();
            }
          });
        } else {
          // Fallback
          if (confirm('Are you sure you want to delete ' + companyName + '?')) {
            form.submit();
          }
        }
      });
    });
  });
</script>
{% endblock %}

